# 运单身份验证页说明文档

## 页面概述

运单身份验证页用于在用户查看运单详情前进行身份验证，保护用户隐私，确保只有寄件人或收件人可以查看运单详情。

## 功能特性

### 1. 页面布局
- **无确认按钮设计**：输入完4位数字后自动触发验证
- **渐变背景**：紫色渐变背景（#667eea → #764ba2）
- **卡片式设计**：白色圆角卡片，带阴影效果
- **响应式布局**：适配不同屏幕尺寸

### 2. 运单信息展示
- **物流公司名称**：显示运单所属的物流公司
- **运单号**：显示完整的运单号码
- **信息来源**：通过API `/com/waybill/getWaybillInfo` 获取

### 3. 验证码输入
- **4位数字输入**：使用自定义 `code-input` 组件
- **自动聚焦**：页面加载后自动聚焦到输入框
- **实时反馈**：输入时清空错误提示
- **输入完成自动验证**：输入满4位数字后自动触发验证逻辑

### 4. 验证逻辑
- **验证方式**：前端本地验证，对比手机号后四位
- **验证规则**：
  - 获取运单信息中的 `sendPhone`（寄件人手机号）和 `collectPhone`（收件人手机号）
  - 提取两个手机号的后四位
  - 用户输入的4位数字与任一手机号后四位匹配即验证成功
- **验证代码**：
  ```javascript
  const sendPhoneLast4 = sendPhone.slice(-4)
  const collectPhoneLast4 = collectPhone.slice(-4)
  const isValid = inputCode === sendPhoneLast4 || inputCode === collectPhoneLast4
  ```

### 5. 验证成功处理
- **成功提示**：显示"验证成功"的Toast提示（1.5秒）
- **自动跳转**：延迟1.5秒后自动跳转到运单详情页
- **传递验证标记**：跳转时携带 `verified=true` 参数
- **使用redirectTo**：使用 `wx.redirectTo` 替换当前页面，防止用户返回验证页

### 6. 验证失败处理
- **错误提示**：显示"验证失败，请重新输入"的Toast提示（2秒）
- **错误动画**：错误提示文字带抖动动画效果
- **延迟清空**：2秒后自动清空输入框
- **错误计数**：记录验证失败次数，显示"已尝试 X/3 次"

### 7. 重试限制
- **最大次数**：最多允许3次验证失败
- **达到上限**：第3次失败后显示弹窗提示"验证次数已达上限，请稍后再试"
- **自动返回**：用户确认后自动返回上一页

### 8. 返回按钮
- **微信原生导航栏**：使用微信小程序原生的返回按钮
- **返回行为**：点击返回按钮返回到上一页（查询结果页或首页）

## 页面参数

### 输入参数
| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| waybillCode | string | 是 | 运单号 |
| companyId | number | 是 | 物流公司ID |

### 输出参数
跳转到运单详情页时传递：
| 参数名 | 类型 | 说明 |
|--------|------|------|
| waybillCode | string | 运单号 |
| companyId | number | 物流公司ID |
| verified | boolean | 验证标记，固定为true |

## 数据流程

### 1. 页面加载流程
```
用户进入页面
  ↓
接收参数（waybillCode, companyId）
  ↓
验证参数完整性
  ↓
调用 API 获取运单信息
  ↓
显示物流公司名称和运单号
  ↓
自动聚焦到验证码输入框
```

### 2. 验证流程
```
用户输入4位数字
  ↓
自动触发验证
  ↓
获取寄件人和收件人手机号后四位
  ↓
对比用户输入
  ↓
验证成功？
  ├─ 是 → 显示成功提示 → 跳转到详情页
  └─ 否 → 显示失败提示 → 增加错误次数 → 延迟清空输入框
           ↓
         错误次数 >= 3？
           ├─ 是 → 显示上限提示 → 返回上一页
           └─ 否 → 允许重新输入
```

## API 接口

### 获取运单信息
- **接口路径**：`GET /com/waybill/getWaybillInfo`
- **请求参数**：
  - `waybillCode`: 运单号
  - `companyId`: 物流公司ID
- **响应数据**：
  ```javascript
  {
    companyName: "百达物流",
    waybillCode: "YD24112700001",
    sendPhone: "13800138000",
    collectPhone: "13900139000",
    // ... 其他运单信息
  }
  ```
- **是否需要登录**：否

## 组件依赖

### code-input 组件
- **路径**：`/components/code-input/code-input`
- **属性**：
  - `codeLength`: 验证码长度，固定为4
  - `autoFocus`: 是否自动聚焦，设置为true
- **事件**：
  - `bind:change`: 输入变化事件
  - `bind:complete`: 输入完成事件（输入满4位时触发）
- **方法**：
  - `clear()`: 清空输入框

## 样式设计

### 颜色方案
- **背景渐变**：#667eea → #764ba2
- **卡片背景**：#FFFFFF
- **主文字颜色**：#333333
- **次要文字颜色**：#666666
- **提示文字颜色**：#999999
- **错误文字颜色**：#FF4444

### 尺寸规范
- **卡片圆角**：32rpx
- **卡片内边距**：64rpx 48rpx
- **字体大小**：
  - 标签文字：28rpx
  - 提示文字：28rpx
  - 错误提示：26rpx
  - 重试提示：24rpx

### 动画效果
- **抖动动画**：错误提示时触发，持续0.5秒
- **动画关键帧**：左右摆动10rpx

## 错误处理

### 1. 参数缺失
- **检测时机**：页面加载时
- **处理方式**：显示"参数错误"弹窗，用户确认后返回上一页

### 2. 运单信息加载失败
- **检测时机**：调用API时
- **处理方式**：显示"加载失败"弹窗，用户确认后返回上一页

### 3. 运单信息不完整
- **检测时机**：验证时
- **处理方式**：显示"运单信息不完整"Toast提示

### 4. 验证次数超限
- **检测时机**：第3次验证失败后
- **处理方式**：显示"验证次数已达上限"弹窗，用户确认后返回上一页

## 用户体验优化

### 1. 自动化操作
- 页面加载后自动聚焦输入框
- 输入完成后自动触发验证
- 验证成功后自动跳转

### 2. 即时反馈
- 输入时清空错误提示
- 验证成功显示成功提示
- 验证失败显示失败提示和抖动动画

### 3. 防误操作
- 验证中状态锁定，防止重复验证
- 延迟清空输入框，让用户看到错误提示
- 达到上限后强制返回，防止无限重试

### 4. 信息透明
- 显示当前错误次数和最大次数
- 清晰的错误提示信息
- 友好的成功提示

## 安全性考虑

### 1. 前端验证
- 验证逻辑在前端执行，无需发送敏感信息到服务器
- 手机号后四位验证，平衡安全性和便利性

### 2. 重试限制
- 最多3次验证机会，防止暴力破解
- 达到上限后强制返回，增加攻击成本

### 3. 验证标记
- 跳转到详情页时传递验证标记
- 详情页应检查验证标记，未验证则跳转回验证页

## 测试要点

### 功能测试
- [ ] 页面正常加载，显示运单信息
- [ ] 输入4位数字后自动触发验证
- [ ] 输入正确的手机号后四位，验证成功并跳转
- [ ] 输入错误的手机号后四位，显示错误提示并清空输入框
- [ ] 连续3次输入错误，显示上限提示并返回上一页
- [ ] 点击返回按钮，正常返回上一页

### 边界测试
- [ ] 缺少参数时，显示错误提示并返回
- [ ] 运单信息加载失败时，显示错误提示并返回
- [ ] 运单信息中缺少手机号时，显示错误提示

### 用户体验测试
- [ ] 页面加载后输入框自动聚焦
- [ ] 输入时错误提示自动清空
- [ ] 验证失败后2秒自动清空输入框
- [ ] 错误提示带抖动动画效果
- [ ] 验证成功后1.5秒自动跳转

## 开发日志

### 2024-01-XX
- ✅ 完成页面布局设计（无确认按钮）
- ✅ 实现运单信息展示功能
- ✅ 集成4位验证码输入组件
- ✅ 实现输入监听和自动验证逻辑
- ✅ 实现验证成功自动跳转功能
- ✅ 实现验证失败提示和延迟清空功能
- ✅ 实现重试限制（最多3次）
- ✅ 实现返回按钮功能
- ✅ 添加完整的中文注释
- ✅ 创建说明文档

## 相关文件

- **页面文件**：
  - `waybill-verify.wxml` - 页面结构
  - `waybill-verify.js` - 页面逻辑
  - `waybill-verify.wxss` - 页面样式
  - `waybill-verify.json` - 页面配置
  - `README.md` - 说明文档

- **依赖组件**：
  - `/components/code-input/code-input` - 验证码输入组件

- **依赖服务**：
  - `/services/api.js` - API服务

## 后续优化建议

1. **增强安全性**：
   - 考虑添加图形验证码，防止自动化攻击
   - 考虑添加验证失败冷却时间

2. **改进用户体验**：
   - 添加键盘弹出动画
   - 优化输入框样式，增加视觉反馈
   - 添加触觉反馈（震动）

3. **功能扩展**：
   - 支持其他验证方式（如身份证后四位）
   - 添加"忘记手机号"帮助入口
   - 支持验证码重发功能（如果改为短信验证）

4. **性能优化**：
   - 预加载运单信息，减少等待时间
   - 优化动画性能，使用CSS3硬件加速
