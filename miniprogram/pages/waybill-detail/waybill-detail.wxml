<!--pages/waybill-detail/waybill-detail.wxml-->
<!-- è¿å•è¯¦æƒ…é¡µ -->
<view class="waybill-detail-page">
  <!-- æ ‡ç­¾é¡µå¯¼èˆª - å·¦å¯¹é½ -->
  <view class="tab-nav">
    <view class="tab-item {{currentTab === 0 ? 'active' : ''}}" bindtap="onTabChange" data-index="0">
      <text class="tab-text">ç”µå­å­˜æ ¹</text>
    </view>
    <view class="tab-item {{currentTab === 1 ? 'active' : ''}}" bindtap="onTabChange" data-index="1">
      <text class="tab-text">è¿è¾“çŠ¶æ€</text>
    </view>
  </view>

  <!-- æ ‡ç­¾é¡µå†…å®¹ -->
  <view class="tab-content">
    <!-- ç”µå­å­˜æ ¹æ ‡ç­¾é¡µ -->
    <view class="tab-panel" wx:if="{{currentTab === 0}}">
      <view class="stub-content">
        <!-- æ¡å½¢ç åŒºåŸŸ -->
        <view class="barcode-section">
          <view class="barcode-wrapper">
            <barcode code="{{waybillInfo.waybillCode}}" width="400" height="80" showTip="{{false}}" showCode="{{false}}"></barcode>
          </view>
          <view class="barcode-divider"></view>
          <view class="barcode-right">
            <text class="dest-text">ç›®çš„åœ°</text>
            <text class="bill-text">{{waybillInfo.discDeptName || '--'}}</text>
          </view>
        </view>

        <!-- å¯„ä»¶æ–¹ä¿¡æ¯ -->
        <view class="info-section">
          <view class="section-label">å¯„ä»¶æ–¹ï¼š</view>
          <view class="info-content">
            <view class="info-row">
              <view class="info-left">
                <view class="icon-circle gray">å‘</view>
                <text class="info-name">{{waybillInfo.sendName || '--'}}</text>
              </view>
              <view class="info-right">
                <text class="info-phone">{{sendPhoneMasked || '--'}}</text>
                <view class="eye-icon {{showSendPhone ? 'eye-close' : 'eye-open'}}" bindtap="onTogglePhone" data-type="send"></view>
              </view>
            </view>
            <view class="info-address">{{waybillInfo.sendAddress || '--'}}</view>
          </view>
        </view>

        <!-- æ”¶ä»¶æ–¹ä¿¡æ¯ -->
        <view class="info-section">
          <view class="section-label">æ”¶ä»¶æ–¹ï¼š</view>
          <view class="info-content">
            <view class="info-row">
              <view class="info-left">
                <view class="icon-circle red">æ”¶</view>
                <text class="info-name">{{waybillInfo.collectName || '--'}}</text>
              </view>
              <view class="info-right">
                <text class="info-phone">{{collectPhoneMasked || '--'}}</text>
                <view class="eye-icon {{showCollectPhone ? 'eye-close' : 'eye-open'}}" bindtap="onTogglePhone" data-type="collect"></view>
              </view>
            </view>
            <view class="info-address">{{waybillInfo.collectAddress || '--'}}</view>
          </view>
        </view>

        <!-- æ‰˜å¯„ç‰©è¡¨æ ¼ -->
        <view class="info-table">
          <view class="table-row">
            <text class="table-cell label">æ‰˜å¯„ç‰©</text>
            <text class="table-cell label">åŒ…è£…/ä»¶æ•°</text>
            <text class="table-cell label">é‡é‡/ä½“ç§¯</text>
          </view>
          <view class="table-row" wx:for="{{waybillInfo.goodsList || []}}" wx:key="index">
            <text class="table-cell value">{{item.goodsName || '--'}}</text>
            <text class="table-cell value">{{(item.packMethod !== null && item.packMethod !== undefined && item.packMethod !== '') || item.totalNum !== null && item.totalNum !== undefined ? ((item.packMethod !== null && item.packMethod !== undefined && item.packMethod !== '') ? item.packMethod : '--') + '/' + (item.totalNum !== null && item.totalNum !== undefined ? item.totalNum + 'ä»¶' : '--') : '--'}}</text>
            <text class="table-cell value">{{item.totalWeight !== null && item.totalWeight !== undefined || item.totalVolume !== null && item.totalVolume !== undefined ? (item.totalWeight !== null && item.totalWeight !== undefined ? item.totalWeight + 'å…¬æ–¤' : '--') + '/' + (item.totalVolume !== null && item.totalVolume !== undefined ? item.totalVolume + 'æ–¹' : '--') : '--'}}</text>
          </view>
          <view class="table-row" wx:if="{{!(waybillInfo.goodsList && waybillInfo.goodsList.length > 0)}}">
            <text class="table-cell value">--</text>
            <text class="table-cell value">--</text>
            <text class="table-cell value">--</text>
          </view>
        </view>

        <!-- é€è´§æ–¹å¼è¡¨æ ¼ -->
        <view class="info-table">
          <view class="table-row">
            <text class="table-cell label">é€è´§æ–¹å¼</text>
            <text class="table-cell label">æ”¾è´§æ–¹å¼</text>
            <text class="table-cell label">å›å•ç±»å‹</text>
          </view>
          <view class="table-row">
            <text class="table-cell value">{{deliveryMethodText || '--'}}</text>
            <text class="table-cell value">{{releaseMethodText || '--'}}</text>
            <text class="table-cell value">{{receiptTypeText || '--'}}</text>
          </view>
        </view>

        <!-- æ˜¯å¦ä¿ä»·è¡¨æ ¼ -->
        <view class="info-table two-col">
          <view class="table-row">
            <text class="table-cell label">æ˜¯å¦ä¿ä»·</text>
            <text class="table-cell label">æ˜¯å¦ä»£æ”¶è´§æ¬¾</text>
          </view>
          <view class="table-row">
            <text class="table-cell value">{{insuredText || '--'}}</text>
            <text class="table-cell value">{{collectionText || '--'}}</text>
          </view>
        </view>

        <!-- åº•éƒ¨ä¿¡æ¯ -->
        <view class="bottom-info">
          <view class="bottom-row">
            <text class="bottom-label">å¤‡æ³¨ï¼š</text>
            <text class="bottom-value">{{waybillInfo.remark || ''}}</text>
          </view>
          <view class="bottom-row">
            <text class="bottom-label">å¯„ä»¶æ—¶é—´ï¼š</text>
            <text class="bottom-value">{{createTimeFormatted || '--'}}</text>
          </view>
          <view class="bottom-row">
            <text class="bottom-label">æ½æ”¶ç½‘ç‚¹ï¼š</text>
            <text class="bottom-value">{{waybillInfo.billDeptName || '--'}}</text>
          </view>
        </view>
      </view>
    </view>

    <!-- è¿è¾“çŠ¶æ€æ ‡ç­¾é¡µ -->
    <view class="tab-panel" wx:if="{{currentTab === 1}}">
      <view class="status-content">
        <!-- å½“å‰çŠ¶æ€å¤´éƒ¨ -->
        <view class="status-header">
          <view class="status-left">
            <!-- èŠ‚ç‚¹åç§°ï¼šæ ¹æ®nodeTypeåˆ¤æ–­ -->
            <view class="status-title" wx:if="{{trackList.length > 0}}">
              <text>{{(trackList[0].nodeType === null || trackList[0].nodeType === undefined || trackList[0].nodeType === '') ? 'å·²å¼€å•' : trackList[0].nodeName}}</text>
            </view>
            <view class="status-title" wx:else>
              <text>å·²å¼€å•</text>
            </view>
            <view class="status-title-divider"></view>
            <view class="status-time-row">
              <!-- æ—¶é—´æ ‡é¢˜æ ¹æ®nodeTypeå˜åŒ–ï¼Œæ— æ•°æ®æ—¶é»˜è®¤æ˜¾ç¤ºå¼€å•æ—¶é—´ -->
              <text class="status-label" wx:if="{{trackList.length === 0 || trackList[0].nodeType === null || trackList[0].nodeType === undefined || trackList[0].nodeType === ''}}">å¼€å•æ—¶é—´ï¼š</text>
              <text class="status-label" wx:elif="{{trackList[0].nodeType === 'collect'}}">æ½æ”¶æ—¶é—´ï¼š</text>
              <text class="status-label" wx:elif="{{trackList[0].nodeType === 'transit'}}">è¿é€æ—¶é—´ï¼š</text>
              <text class="status-label" wx:else>è¿é€æ—¶é—´ï¼š</text>
              <!-- æ—¶é—´å€¼ï¼šnodeTimeä¸ºç©ºæ˜¾ç¤ºç©ºå€¼ï¼Œæœ‰å€¼æ˜¾ç¤ºæ—¶é—´ -->
              <text class="status-value" wx:if="{{trackList.length > 0}}">{{trackList[0].nodeTime ? trackList[0].nodeTimeFormattedShort : ''}}</text>
              <text class="status-value" wx:else></text>
            </view>
          </view>
          <view class="status-divider-v"></view>
          <view class="status-center">
            <text class="from-address">{{waybillInfo.billDeptName || '--'}}</text>
          </view>
          <view class="status-arrow">
            <view class="arrow-circle">
              <text class="arrow-text">â†’</text>
            </view>
          </view>
          <view class="status-right">
            <text class="to-address">{{waybillInfo.discDeptName || '--'}}</text>
          </view>
        </view>
        <!-- ç‰©æµè½¨è¿¹åˆ—è¡¨ -->
        <view class="track-section">
          <view class="track-list" wx:if="{{trackList.length > 0}}">
            <view class="track-item {{index === 0 ? 'active' : ''}} {{item.showTitle ? 'show-title' : 'no-title'}}" wx:for="{{trackList}}" wx:key="index">
              <view class="track-left">
                <!-- å›¾æ ‡é€»è¾‘ï¼š
                     1. showTitle=trueï¼šæ˜¾ç¤ºå¤§å›¾æ ‡ï¼ˆ45rpxï¼‰
                     2. showTitle=falseï¼šæ˜¾ç¤ºå°åœ†ç‚¹
                     3. ç¬¬ä¸€æ¡æ•°æ®(index===0)ï¼šçº¢è‰²å›¾æ ‡
                     4. å…¶ä»–æ•°æ®ï¼šç°è‰²å›¾æ ‡
                -->
                <view class="track-icon-wrap {{index === 0 ? 'active' : 'received'}} {{item.showTitle ? 'icon-large' : 'icon-small'}}">
                  <view class="track-icon-inner">
                    <!-- showTitle=trueæ—¶æ˜¾ç¤ºå¤§å›¾æ ‡ -->
                    <block wx:if="{{item.showTitle}}">
                      <!-- ç­¾æ”¶ï¼šæ”¶å­— -->
                      <text class="icon-sign" wx:if="{{item.nodeType === 'sign'}}">æ”¶</text>
                      <!-- è¿é€ä¸­/æ´¾é€ä¸­ï¼šğŸšš -->
                      <text class="icon-truck" wx:elif="{{item.nodeType === 'transit' || item.nodeType === 'delivery'}}">ğŸšš</text>
                      <!-- æ½æ”¶æˆ–å…¶ä»–ï¼šğŸ“¦ -->
                      <text class="icon-received" wx:else>ğŸ“¦</text>
                    </block>
                    <!-- showTitle=falseæ—¶æ˜¾ç¤ºå°åœ†ç‚¹ -->
                    <view class="icon-dot-small" wx:else></view>
                  </view>
                </view>
                <view class="track-line" wx:if="{{index < trackList.length - 1}}"></view>
              </view>
              <view class="track-right">
                <!-- èŠ‚ç‚¹åç§°ï¼ˆä»…å½“showTitleä¸ºtrueæ—¶æ˜¾ç¤ºï¼‰ -->
                <view class="track-status-wrap" wx:if="{{item.showTitle && item.nodeName}}">
                  <text class="track-status">{{item.nodeName}}</text>
                </view>
                <!-- æ—¶é—´å’Œå†…å®¹ -->
                <view class="track-content">
                  <!-- æ—¶é—´ -->
                  <view class="track-time-row" wx:if="{{item.nodeTime}}">
                    <text class="track-time">{{item.nodeTimeFormatted || item.nodeTime}}</text>
                  </view>
                  <!-- å†…å®¹ï¼šæ ¹æ®contentListæ¸²æŸ“ï¼Œæ‰‹æœºå·æ˜¾ç¤ºä¸ºè“è‰²å¹¶å¯ç‚¹å‡» -->
                  <view class="track-detail" wx:if="{{item.contentList && item.contentList.length > 0}}">
                    <block wx:for="{{item.contentList}}" wx:for-item="contentItem" wx:key="index">
                      <text class="content-text {{contentItem.type === 'phone' ? 'phone-blue' : ''}} {{index === 0 ? '' : 'content-text-gray'}}" bindtap="{{contentItem.type === 'phone' ? 'onMakePhoneCall' : ''}}" data-phone="{{contentItem.value}}">{{contentItem.value}}</text>
                    </block>
                  </view>
                  <!-- å…¼å®¹æ—§æ ¼å¼ï¼šã€éƒ¨é—¨ æ‰‹æœºå·ã€‘äº‹ä»¶å†…å®¹ -->
                  <view class="track-detail" wx:elif="{{item.deptName || item.userName || item.nodeContent}}">
                    <text class="content-text {{index === 0 ? '' : 'content-text-gray'}}" wx:if="{{item.deptName || item.userName}}">ã€{{item.deptName || ''}} </text>
                    <text class="content-text phone-blue {{index === 0 ? '' : 'content-text-gray'}}" wx:if="{{item.userName}}" bindtap="onMakePhoneCall" data-phone="{{item.userName}}">{{item.userName}}</text>
                    <text class="content-text {{index === 0 ? '' : 'content-text-gray'}}" wx:if="{{item.deptName || item.userName}}">ã€‘</text>
                    <text class="content-text {{index === 0 ? '' : 'content-text-gray'}}" wx:if="{{item.nodeContent}}">{{item.nodeContent}}</text>
                  </view>
                </view>
              </view>
            </view>
          </view>
          <!-- ç©ºçŠ¶æ€ -->
          <view class="empty-state" wx:if="{{trackList.length === 0}}">
            <text>æš‚æ— æ•°æ®</text>
          </view>
        </view>
      </view>
    </view>
  </view>
</view>
