# 运单详情页说明文档

## 页面概述

运单详情页用于展示运单的完整信息，包括电子存根和运输状态两个标签页。用户必须通过身份验证后才能查看详情。

## 功能特性

### 1. 身份验证检查
- 页面加载时检查`verified`参数
- 未验证用户自动跳转到验证页面
- 验证通过后才能查看运单详情

### 2. 标签页切换
- **电子存根**：展示运单的详细信息
- **运输状态**：展示物流轨迹和当前状态

### 3. 电子存根标签页

#### 3.1 条形码展示
- 使用自定义条形码组件展示运单号
- 支持长按保存条形码图片
- 显示目的地和发站部门信息

#### 3.2 寄件方/收件方信息
- 显示姓名、电话、地址
- 电话号码默认脱敏显示（157****5896）
- 点击眼睛图标可查看完整电话号码
- 再次点击恢复脱敏显示

#### 3.3 货物信息
- 表格形式展示货物列表
- 显示托寄物、包装/件数、重量/体积
- 支持多个货物项展示

#### 3.4 服务信息
- 送货方式：自提/送货
- 放货方式：等通知/其他
- 回单类型：电子回单/纸质回单

#### 3.5 费用信息
- 是否保价：根据保价金额判断
- 是否代收货款：根据代收金额判断

#### 3.6 其他信息
- 备注信息
- 寄件时间
- 接收网点

### 4. 运输状态标签页

#### 4.1 当前状态卡片
- 显示物流状态描述
- 显示到站部门名称
- 显示开单时间
- 黄色背景突出显示

#### 4.2 物流轨迹时间轴
- 按时间倒序显示（最新的在上面）
- 显示操作时间、事件内容
- 显示操作部门和操作员
- 使用时间轴样式展示

#### 4.3 暂无数据提示
- 当没有物流轨迹时显示"暂无数据"

### 5. 查询历史标记
- 页面加载时自动标记查询历史
- 仅在用户已登录时执行
- 失败不影响页面显示

### 6. 下拉刷新
- 支持下拉刷新功能
- 同时刷新运单详情和物流轨迹

## 数据字段映射

### 运单详情接口：`/com/waybill/getWaybillInfo`

```javascript
{
  waybillCode: "运单号",
  destDeptName: "目的地部门",
  billDeptName: "发站部门",
  sendName: "寄件人姓名",
  sendPhone: "寄件人电话",
  sendAddress: "寄件人地址",
  collectName: "收件人姓名",
  collectPhone: "收件人电话",
  collectAddress: "收件人地址",
  goodsList: [
    {
      goodsName: "货物名称",
      packMethod: "包装方式",
      totalNum: "总件数",
      totalWeight: "总重量",
      totalVolume: "总体积"
    }
  ],
  deliveryMethod: "送货方式", // 1-自提 2-送货
  releaseMethod: "放货方式", // 1-等通知 2-其他
  receiptType: "回单类型", // 1-电子回单 2-纸质回单
  insuredAmount: "保价金额",
  collectionDelivery: "代收货款",
  remark: "备注",
  waybillCreateTime: "寄件时间",
  discDeptName: "到站部门",
  orderStatusDesc: "物流状态描述"
}
```

### 物流轨迹接口：`/com/waybill/getWaybillTrackInfo`

```javascript
[
  {
    createTime: "操作时间",
    eventLog: "操作内容",
    eventNode: "操作节点",
    eventType: "操作类型",
    deptName: "操作部门",
    userName: "操作员"
  }
]
```

## 页面参数

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| waybillCode | String | 是 | 运单号 |
| companyId | Number | 是 | 物流公司ID |
| verified | String | 是 | 验证标记，必须为'true' |

## 使用示例

### 从验证页跳转到详情页

```javascript
// 验证成功后跳转
wx.redirectTo({
  url: `/pages/waybill-detail/waybill-detail?waybillCode=${waybillCode}&companyId=${companyId}&verified=true`
})
```

### 从首页跳转（需先验证）

```javascript
// 跳转到验证页
wx.navigateTo({
  url: `/pages/waybill-verify/waybill-verify?waybillCode=${waybillCode}&companyId=${companyId}`
})
```

## 样式设计

### 颜色规范
- 主色调：红色 #FF0000（标签页选中状态）
- 背景色：浅灰 #F5F5F5
- 卡片背景：白色 #FFFFFF
- 状态卡片背景：浅黄 #FFF8DC
- 文字颜色：
  - 主文字：#333333
  - 次要文字：#666666
  - 提示文字：#999999

### 布局规范
- 页面内边距：24rpx
- 卡片内边距：32rpx
- 卡片圆角：16rpx
- 元素间距：16-32rpx

## 组件依赖

- **barcode**：条形码展示组件（`/components/barcode/barcode`）

## 工具依赖

- **api.js**：API请求服务
- **phone-mask.js**：电话号码脱敏工具
- **auth.js**：认证服务

## 注意事项

1. **验证检查**：页面必须通过验证才能访问，未验证会自动跳转
2. **电话脱敏**：默认脱敏显示，点击眼睛图标可查看完整号码
3. **数据容错**：所有字段都做了空值判断，避免显示undefined
4. **时间排序**：物流轨迹按时间倒序显示（最新的在上面）
5. **登录状态**：查询历史标记功能需要登录，未登录不影响页面显示
6. **下拉刷新**：支持下拉刷新，同时更新运单详情和物流轨迹

## 后续优化建议

1. 添加运单分享功能
2. 添加订阅运单更新通知功能
3. 优化条形码生成算法，使用标准的Code 128编码
4. 添加物流地图展示功能
5. 添加运单评价功能

## 更新日志

### 2025-01-XX
- ✅ 实现页面布局和标签页切换
- ✅ 实现验证标记检查
- ✅ 实现电子存根标签页（条形码、寄收件方信息、货物信息、服务信息、费用信息）
- ✅ 实现运输状态标签页（当前状态卡片、物流轨迹时间轴、暂无数据提示）
- ✅ 实现查询历史标记功能
- ✅ 集成条形码组件
- ✅ 实现电话脱敏和查看功能
- ✅ 实现下拉刷新功能
