# 物流追踪小程序 - 发布部署指南

## 概述

本文档提供物流追踪小程序的完整发布部署指南，包括配置、审核、发布等流程。

---

## 任务16：发布准备

### 16.1 配置生产环境 API 地址

#### 1. 修改 API 配置文件

**文件路径**：`config/api-config.js`

**修改内容**：
```javascript
/**
 * API 配置
 */

// 环境配置
const ENV = {
  // 开发环境
  DEV: {
    BASE_URL: 'http://localhost:8080',  // 本地开发地址
    ENV_NAME: 'development'
  },
  
  // 测试环境
  TEST: {
    BASE_URL: 'https://test-api.example.com',  // 测试服务器地址
    ENV_NAME: 'test'
  },
  
  // 生产环境
  PROD: {
    BASE_URL: 'https://api.example.com',  // 生产服务器地址（需要替换）
    ENV_NAME: 'production'
  }
};

// 当前环境（发布前改为 'PROD'）
const CURRENT_ENV = 'PROD';

// 获取当前环境配置
const getCurrentEnv = () => {
  return ENV[CURRENT_ENV];
};

module.exports = {
  // 导出基础URL
  getBaseURL: () => getCurrentEnv().BASE_URL,
  
  // 导出环境名称
  getEnvName: () => getCurrentEnv().ENV_NAME,
  
  // 请求超时时间（毫秒）
  REQUEST_TIMEOUT: 10000,
  
  // 请求重试次数
  REQUEST_RETRY_COUNT: 3
};
```

**重要提示**：
- ⚠️ 将 `CURRENT_ENV` 改为 `'PROD'`
- ⚠️ 将 `PROD.BASE_URL` 替换为实际的生产服务器地址
- ⚠️ 确保生产服务器地址使用 HTTPS 协议

#### 2. 修改小程序跳转配置

**文件路径**：`config/miniapp-config.js`

**修改内容**：
```javascript
module.exports = {
  /**
   * 线路查询小程序配置
   */
  routeQuery: {
    // 小程序 appId（替换为实际的 appId）
    appId: 'wx1234567890abcdef',  // ⚠️ 需要替换
    path: '',
    envVersion: 'release',  // 发布时使用 'release'
    extraData: {
      from: 'logistics-tracking'
    }
  },

  /**
   * 快捷下单小程序配置
   */
  quickOrder: {
    // 小程序 appId（替换为实际的 appId）
    appId: 'wx0987654321fedcba',  // ⚠️ 需要替换
    path: '',
    envVersion: 'release',  // 发布时使用 'release'
    extraData: {
      from: 'logistics-tracking'
    }
  }
};
```

**重要提示**：
- ⚠️ 将占位符 appId 替换为实际的小程序 appId
- ⚠️ 将 `envVersion` 改为 `'release'`
- ⚠️ 同时更新 `app.json` 中的 `navigateToMiniProgramAppIdList`

---

### 16.2 配置小程序信息

#### 1. 基本信息配置

**文件路径**：`app.json`

**检查项**：
- [ ] 页面路径配置正确
- [ ] 窗口配置正确
- [ ] 导航栏标题正确
- [ ] 权限配置完整
- [ ] 小程序跳转白名单配置正确

**示例配置**：
```json
{
  "pages": [
    "pages/index/index",
    "pages/waybill-verify/waybill-verify",
    "pages/waybill-detail/waybill-detail",
    "pages/company-detail/company-detail",
    "pages/notice-list/notice-list",
    "pages/notice-detail/notice-detail"
  ],
  "window": {
    "backgroundColor": "#F5F5F5",
    "backgroundTextStyle": "light",
    "navigationBarBackgroundColor": "#FFFFFF",
    "navigationBarTitleText": "物流追踪",
    "navigationBarTextStyle": "black"
  },
  "navigateToMiniProgramAppIdList": [
    "wx1234567890abcdef",  // ⚠️ 替换为实际的 appId
    "wx0987654321fedcba"   // ⚠️ 替换为实际的 appId
  ],
  "permission": {
    "scope.userLocation": {
      "desc": "你的位置信息将用于地图导航"
    }
  }
}
```

#### 2. 小程序信息配置

**在微信公众平台配置**：
1. 登录 [微信公众平台](https://mp.weixin.qq.com/)
2. 进入"设置" → "基本设置"
3. 配置以下信息：
   - 小程序名称：物流追踪
   - 小程序简介：专为物流专线打造的运单追踪场景应用平台
   - 小程序头像：上传Logo图片
   - 服务类目：交通出行 → 物流服务
   - 标签：物流、快递、运单查询

#### 3. 服务器域名配置

**在微信公众平台配置**：
1. 进入"开发" → "开发管理" → "开发设置"
2. 配置服务器域名：
   - request合法域名：`https://api.example.com`（生产服务器域名）
   - uploadFile合法域名：（如需要）
   - downloadFile合法域名：（如需要）
   - socket合法域名：（如需要）

**重要提示**：
- ⚠️ 域名必须使用 HTTPS 协议
- ⚠️ 域名必须备案
- ⚠️ 每月只能修改5次

---

### 16.3 提交审核

#### 1. 上传代码

**步骤**：
1. 打开微信开发者工具
2. 点击工具栏"上传"按钮
3. 填写版本号和项目备注：
   - 版本号：1.0.0
   - 项目备注：初始版本，包含运单查询、公司详情、通知公告等功能
4. 点击"上传"

#### 2. 提交审核

**步骤**：
1. 登录微信公众平台
2. 进入"版本管理"
3. 找到刚上传的版本
4. 点击"提交审核"
5. 填写审核信息：

**审核信息填写**：

**功能页面**：
- 首页：pages/index/index
- 运单详情：pages/waybill-detail/waybill-detail
- 公司详情：pages/company-detail/company-detail

**测试账号**：
- 提供测试账号和密码（如需要）
- 提供测试运单号

**补充说明**：
```
本小程序为物流运单追踪应用，主要功能包括：
1. 运单查询：用户可通过运单号查询物流信息
2. 运单详情：查看运单的电子存根和运输状态
3. 公司详情：查看物流公司信息、网点、线路等
4. 通知公告：查看平台发布的通知公告

测试说明：
- 测试运单号：YD20240101001
- 验证码：手机号后四位
```

#### 3. 审核注意事项

**常见审核问题**：
1. **服务类目不符**：确保选择正确的服务类目
2. **功能不完整**：确保所有功能都能正常使用
3. **测试账号问题**：提供有效的测试账号和数据
4. **隐私政策缺失**：添加隐私政策页面
5. **用户协议缺失**：添加用户协议页面

**审核时间**：
- 一般审核时间：1-7个工作日
- 加急审核：需要特殊申请

---

### 16.4 发布上线

#### 1. 审核通过后发布

**步骤**：
1. 登录微信公众平台
2. 进入"版本管理"
3. 找到审核通过的版本
4. 点击"发布"按钮
5. 确认发布

#### 2. 发布后验证

**验证项**：
- [ ] 小程序可以正常搜索到
- [ ] 所有功能正常使用
- [ ] 接口调用正常
- [ ] 数据显示正确
- [ ] 性能表现良好

#### 3. 灰度发布（可选）

**步骤**：
1. 在"版本管理"中选择"灰度发布"
2. 设置灰度比例（如10%）
3. 观察灰度用户反馈
4. 逐步提高灰度比例
5. 最终全量发布

---

## 发布检查清单

### 代码检查
- [ ] 所有TODO注释已处理
- [ ] 所有console.log已清理
- [ ] 所有测试代码已删除
- [ ] 代码已格式化
- [ ] 代码已通过ESLint检查

### 配置检查
- [ ] API地址已改为生产环境
- [ ] 小程序跳转appId已替换
- [ ] 环境变量已设置为生产环境
- [ ] 服务器域名已配置
- [ ] 权限配置已完整

### 功能检查
- [ ] 所有功能测试通过
- [ ] 兼容性测试通过
- [ ] 性能测试通过
- [ ] 安全测试通过

### 资源检查
- [ ] 图片资源已优化
- [ ] 无用资源已删除
- [ ] 主包大小 < 2MB
- [ ] 总包大小 < 20MB

### 文档检查
- [ ] README文档完整
- [ ] API文档完整
- [ ] 部署文档完整
- [ ] 用户手册完整

---

## 发布后监控

### 数据监控
1. **用户数据**
   - 新增用户数
   - 活跃用户数
   - 用户留存率

2. **功能数据**
   - 运单查询次数
   - 页面访问量
   - 功能使用率

3. **性能数据**
   - 页面加载时间
   - 接口响应时间
   - 错误率

### 用户反馈
1. **收集渠道**
   - 小程序评价
   - 客服反馈
   - 用户调研

2. **问题处理**
   - 及时响应用户反馈
   - 记录常见问题
   - 制定解决方案

---

## 版本更新流程

### 1. 版本规划
- 确定更新内容
- 制定开发计划
- 评估影响范围

### 2. 开发测试
- 开发新功能
- 修复已知问题
- 进行完整测试

### 3. 提交审核
- 更新版本号
- 填写更新说明
- 提交审核

### 4. 发布上线
- 审核通过后发布
- 监控发布效果
- 收集用户反馈

---

## 回滚方案

### 紧急回滚
如果发布后发现严重问题，可以进行版本回滚：

**步骤**：
1. 登录微信公众平台
2. 进入"版本管理"
3. 找到上一个稳定版本
4. 点击"回退"按钮
5. 确认回退

**注意事项**：
- 回退后需要重新提交审核
- 回退会影响所有用户
- 建议先使用灰度发布测试

---

## 常见问题

### Q1: 审核被拒绝怎么办？
**A**: 
1. 查看拒绝原因
2. 根据原因修改代码
3. 重新提交审核
4. 如有疑问，联系微信客服

### Q2: 如何加快审核速度？
**A**:
1. 确保功能完整
2. 提供详细的测试说明
3. 提供有效的测试账号
4. 选择正确的服务类目

### Q3: 发布后发现问题怎么办？
**A**:
1. 评估问题严重程度
2. 如果严重，立即回滚
3. 如果不严重，修复后发布新版本
4. 及时通知用户

### Q4: 如何提高小程序曝光度？
**A**:
1. 优化小程序名称和简介
2. 添加合适的标签
3. 提交到微信搜索
4. 推广小程序码
5. 关联公众号

---

## 联系方式

### 技术支持
- 开发团队：[联系方式]
- 技术文档：[文档地址]

### 微信支持
- 微信公众平台：https://mp.weixin.qq.com/
- 微信开放社区：https://developers.weixin.qq.com/community/

---

**祝发布顺利！** 🎉

